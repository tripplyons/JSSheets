var d={ADD:function(a){if(0===a.length||-1!=a.indexOf(null))return null;for(var b=0,c=0;c<a.length;c++)b+=parseInt(a[c]);return b},SUB:function(a){if(0===a.length||-1!=a.indexOf(null))return null;for(var b=parseInt(a[0])-parseInt(a[1]),c=2;c<a.length;c++)b-=parseInt(a[c]);return b},MUL:function(a){if(0===a.length||-1!=a.indexOf(null))return null;for(var b=parseInt(a[0]),c=1;c<a.length;c++)b*=parseInt(a[c]);return b},DIV:function(a){if(0===a.length||-1!=a.indexOf(null)||0===parseInt(a[1]))return null;
for(var b=parseInt(a[0])/parseInt(a[1]),c=2;c<a.length;c++){if(0===parseInt(a[c]))return null;b/=parseInt(a[c])}return Math.floor(b)},MOD:function(a){return 0===a.length||-1!=a.indexOf(null)?null:0===parseInt(a[1])?null:parseInt(a[0])%parseInt(a[1])},IF:function(a){return 1!=a.length?null:parseInt(a[0])?1:0},NOT:function(a){return 1!=a.length?null:parseInt(a[0])?0:1}};d.SUM=d.ADD;var e=!1,g=document.getElementById("canvas");g.addEventListener("click",h);document.addEventListener("keydown",m);
document.addEventListener("keyup",t);var u=g.getContext("2d"),v="#f7f7f7",w=100,y=25,A=Math.floor(parseInt(g.getAttribute("width"))/w)-1,B=Math.floor(parseInt(g.getAttribute("height"))/y)-2;u.strokeStyle="#000000";u.font=y-5+"px Courier";for(var C=u.measureText(" ").width,D=0,E=0,F,G=[],H="ABCDEFGHIJKLMNOPQRSTUVWXYZ",I="0123456789",G=[],J=0;J<B;J++)for(var K=0;K<A;K++)G.push("0");F=G[0].length;L();
function L(){0>F&&(F=0);u.fillStyle=v;u.fillRect(0,0,(A+1)*w,(B+2)*y);u.strokeStyle="#000000";u.fillStyle="#000000";u.strokeRect(0,0,w,y);u.fillText(H.charAt(D)+E,5,y-5);for(var a=0;a<A;a++)u.strokeRect((a+1)*w,y,w,y),u.fillText(H.charAt(a),(a+1)*w+5,2*y-5);for(a=0;a<B;a++)u.strokeRect(0,(a+2)*y,w,y),u.fillText(a,5,(a+3)*y-5);u.fillStyle="#000000";u.fillText(H.charAt(D)+E,5,-3*y);u.fillText("JSSheets",5,2*y-5);u.fillText(G[E*A+D],w+5,1*y-5);for(a=0;a<B;a++)for(var b=0;b<A;b++){if(b==D&&a==E){u.fillStyle=
"#007fff";var c=(b+1)*w,r=(a+2)*y,f=w,z=y;u.fillRect(c-2,r-2,f+4,z+4);u.fillStyle=v;u.fillRect(c+2,r+2,f-2,z-2)}else u.strokeStyle="#000000",u.strokeRect((b+1)*w,(a+2)*y,w,y);u.fillStyle="#000000";c=null!==M(G[a*A+b],a*A+b,[])?M(G[a*A+b],a*A+b,[]):"ERROR";7<c.toString().length&&(c=c.toString().substring(0,7)+"_");u.fillText(c,(b+1)*w+5,(a+3)*y-5)}u.strokeStyle="#000000";u.strokeRect(w,0,w*A,y);u.strokeRect(0,y,w,y);u.fillStyle="#000000";u.fillRect(w+5+C*F,0*y+5,2,y-10)}
function M(a,b,c){"undefined"==typeof c&&(c=[]);if(-1!=c.indexOf(b))return null;c.push(b);a:if("-"==a.charAt(0)&&1==a.length)b=null;else{for(b="-"==a.charAt(0)?1:0;b<a.length;b++)if(-1==I.indexOf(a.charAt(b))){b=!1;break a}b=!0}if(b)c=a;else if("#"==a.charAt(0))c=a.substring(1,a.length);else if("="==a.charAt(0)&&a.substring(1,a.length).match(/^[A-Z]+\d+$/))c=M(N(parseInt(a.substring(2,a.length))*A+H.indexOf(a.charAt(1))));else{if(4>a.length||"="!=a.charAt(0)||"("==a.charAt(1))b=!1;else{for(b=2;"("!=
a.charAt(b)&&b<a.length;b++);if(b==a.length)b=!1;else{for(;")"!=a.charAt(b)&&b<a.length;)b++;b=b==a.length&&")"!=a.charAt(b)||b!=a.length-1?!1:!0}}if(b)a:{b=c;c=[];var r="",f;for(f=1;f<a.length&&"("!=a.charAt(f);f++)r+=a.charAt(f);for(f=2;f<a.length&&"("!=a.charAt(f);f++);for(f++;f<a.length&&")"!=a.charAt(f);){for(var z="";f<a.length&&" "!=a.charAt(f)&&")"!=a.charAt(f);)z+=a.charAt(f),f++;c.push(z);f++}a=/^[A-Z]+\d+\:[A-Z]+\d+$/;f=/^[A-Z]+\d+$/;for(var z=/^-?\d+$/,k=0;k<c.length;k++)if(c[k]=c[k].toString(),
console.log(c[k]+":"),c[k].match(a)){console.log("cell array");var p=H.indexOf(c[k][0]),x="",n;for(n=1;n<c[k].length&&":"!=c[k][n];n++)x+=c[k][n];var l=parseInt(x);n++;var x=H.indexOf(c[k][n]),q="";for(n++;n<c[k].length;n++)q+=c[k][n];n=parseInt(q);console.log(H[p]+" "+l+" : "+H[x]+" "+n);c.pop();if(l==n&&p==x)console.log("0D array of 1"),console.log(p+", "+l),c.push(M(N(l*A+p),l*A+p,b));else if(l==n)for(console.log("1D horizontal array"),q=p;q<=x;q++)console.log(q+", "+l),c.push(M(N(l*A+q),l*A+q,
b));else if(p==x)for(console.log("1D vertical array");l<=n;l++)console.log(p+", "+l),c.push(M(N(l*A+p),l*A+p,b));else for(console.log("2D array");l<=n;l++)for(q=p;q<=x;q++)console.log(q+", "+l),c.push(M(N(l*A+q),l*A+q,b))}else if(c[k].match(f))console.log("cell"),p=H.indexOf(c[k][0])+parseInt(c[k].substring(1,c[k].length))*A,console.log(p),c[k]=M(N(p),p,b);else if(!c[k].match(z)){c=null;break a}c=(b=d[r])?b(c):null;c=null!==c?c:null}else c=null}return c}
function h(a){var b=D,c=E;console.log("click!");var r;a.pageX||a.pageY?(r=a.pageX,a=a.pageY):(r=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,a=a.clientY+document.body.scrollTop+document.documentElement.scrollTop);r-=g.offsetLeft;a-=g.offsetTop;console.log("("+r.toString()+", "+a.toString()+")");r>=w&&a>=2*y&&a<=y*(B+2)&&(D=Math.floor(r/w)-1,E=Math.floor(a/y)-2);console.log(D+", "+E);if(b!=D||c!=E)F=O().length;L()}function N(a){return a>G.length?null:G[a]}
function P(a){G[E*A+D]=a}function O(){return G[E*A+D]}function Q(a){if(e)switch(a){case 51:return"#";case 57:return"(";case 48:return")";case 186:return":"}switch(a){case 187:return"=";case 32:return" ";case 189:return"-"}return 48<=a&&57>=a?(a-48).toString():65<=a&&90>=a?String.fromCharCode(a):null}
function m(a){var b="undefined"==typeof a.which?a.charCode:a.which;16==b&&(e=!0);8==a.keyCode||46==a.keyCode?(a.preventDefault(),console.log("delete/backspace down"),a=O(),P(a.substring(0,F-1)+a.substring(F,a.length)),""===O()?P("0"):--F,L()):-1!=H.indexOf(String.fromCharCode(b))||Q(b)?("0"==O()?P(Q(b)):(P(O().substring(0,F)+Q(b)+O().substring(F,O().length)),F+=1),L()):37==b?(--F,L()):39==b&&(F+=1,F>O().length&&(F=O().length),L())}
function t(a){16==("undefined"==typeof a.which?a.charCode:a.which)&&(e=!1)};
